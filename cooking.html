<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cooking Map</title>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    #chartdiv {
      width: 100%;
      height: 100vh;
    }

    #info {
      position: absolute;
      top: 12px;
      left: 12px;
      background: white;
      padding: 12px 14px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
      font-size: 14px;
      line-height: 1.4;
      z-index: 30000;
      max-width: min(420px, 92vw);
    }
  </style>

  <!-- AmCharts -->
  <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/map.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/geodata/worldLow.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
</head>

<body>

<div id="chartdiv"></div>

<!-- Floating Notes button that follows the mouse -->
<div id="floatingNotes" style="
  position: fixed;
  display: none;
  z-index: 10000;
  transform: translate(12px, 12px);
  pointer-events: none;
">
  <button id="floatingNotesBtn" style="
    pointer-events: auto;
    cursor: pointer;
    padding: 6px 10px;
    border-radius: 10px;
    border: 1px solid #ddd;
    background: white;
    box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    font-size: 13px;
    font-weight: 700;
  ">Notes</button>
</div>

<div id="info">
  <div style="font-weight:700;">Giu &amp; Mel Cooking and Traveling Around the World</div>
  <div style="margin-top:6px;">Shift + click a country to open notes</div>

  <div style="margin-top:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
    <button id="randomBtn" style="
      cursor:pointer;
      border: 1px solid #ddd;
      background: white;
      border-radius: 10px;
      padding: 6px 10px;
      font-weight: 700;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    ">ðŸŽ² Random</button>
    <span id="randomPick" style="font-size:13px; opacity:0.9;"></span>
  </div>

  <div style="margin-top:10px; line-height:1.5;">
    ðŸŸ© <b>Tried</b> (<span id="triedCount">0</span>/<span id="totalCount">0</span>)<br>
    ðŸŸ§ <b>To try</b> (<span id="totryCount">0</span>/<span id="totalCount2">0</span>)<br>
    â¬œ <b>Not tried</b> (<span id="notTriedCount">0</span>/<span id="totalCount3">0</span>)
  </div>
</div>

<!-- Notes editor modal -->
<div id="notesModal" style="
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.35);
  z-index: 9999;
">
  <div style="
    width: min(700px, 92vw);
    background: white;
    border-radius: 14px;
    box-shadow: 0 10px 28px rgba(0,0,0,0.25);
    padding: 14px;
  ">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
      <div id="notesTitle" style="font-weight:700; font-size:16px;">Notes</div>
      <button id="closeNotes" style="
        cursor:pointer;
        border: 1px solid #ddd;
        background: white;
        border-radius: 10px;
        padding: 6px 10px;
        font-weight: 700;
      ">âœ•</button>
    </div>

    <textarea id="notesArea" style="
      width: 100%;
      height: 320px;
      margin-top: 10px;
      padding: 10px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-size: 14px;
      line-height: 1.4;
      border-radius: 10px;
      border: 1px solid #ddd;
      resize: vertical;
    " placeholder="Write your notes here..."></textarea>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
      <div id="saveStatus" style="opacity:0.7; font-size:12px;"></div>
      <div style="display:flex; gap:8px;">
        <button id="deleteNotes" style="cursor:pointer;">Delete</button>
        <button id="saveNotes" style="cursor:pointer; font-weight:700;">Save &amp; Close</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCPYOVIQ7Mc8sVGkvpnT8Wm9U6e_rcTIWw",
    authDomain: "cooking-map-5fbe2.firebaseapp.com",
    projectId: "cooking-map-5fbe2",
    storageBucket: "cooking-map-5fbe2.appspot.com",
    messagingSenderId: "565526517859",
    appId: "1:565526517859:web:2fdaa595523023e391c056"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  const MAP_ID = "cooking";

  const COLOR_DEFAULT = 0xd1d1d6;
  const COLOR_TRIED   = 0x34c759;
  const COLOR_TOTRY   = 0xff9500;
  const COLOR_FLASH   = 0xffd60a; // YELLOW

  const statusById = {};
  const notesById = {};

  function countryDocRef(id) {
    return doc(db, "maps", MAP_ID, "countries", id);
  }

  // Auth UI
  const authBar = document.createElement("div");
  authBar.style.cssText = `
    position: fixed; top: 12px; right: 12px; z-index: 20000;
    display: flex; gap: 8px; align-items: center;
    background: rgba(255,255,255,0.95);
    padding: 10px 12px; border-radius: 12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  `;
  authBar.innerHTML = `
    <span id="whoami" style="font-size:13px; opacity:0.85;"></span>
    <button id="signin" style="cursor:pointer; font-weight:700;">Sign in</button>
    <button id="signout" style="cursor:pointer; display:none;">Sign out</button>
  `;
  document.body.appendChild(authBar);

  const whoami = authBar.querySelector("#whoami");
  const signinBtn = authBar.querySelector("#signin");
  const signoutBtn = authBar.querySelector("#signout");

  signinBtn.onclick = async () => { await signInWithPopup(auth, provider); };
  signoutBtn.onclick = async () => { await signOut(auth); };

  // Notes UI
  const floatingNotes = document.getElementById("floatingNotes");
  const floatingNotesBtn = document.getElementById("floatingNotesBtn");

  const notesModal = document.getElementById("notesModal");
  const notesTitle = document.getElementById("notesTitle");
  const notesArea  = document.getElementById("notesArea");
  const saveNotes  = document.getElementById("saveNotes");
  const deleteNotes= document.getElementById("deleteNotes");
  const closeNotes = document.getElementById("closeNotes");
  const saveStatus = document.getElementById("saveStatus");

  let hoverId = null;
  let hoverName = null;

  let editId = null;
  let editName = null;

  async function openNotesEditor(id, name) {
    editId = id;
    editName = name;

    notesTitle.textContent = `Notes â€” ${name} (${id})`;
    saveStatus.textContent = "";

    notesModal.style.display = "flex";
    notesArea.focus();

    notesArea.value = notesById[id] || "";

    try {
      const snap = await getDoc(countryDocRef(id));
      if (snap.exists()) {
        const data = snap.data();
        const latest = (data.notes || "");
        notesById[id] = latest;
        notesArea.value = latest;
      } else {
        notesById[id] = "";
        notesArea.value = "";
      }
    } catch (e) {
      console.error("Failed to load notes:", e);
    }
  }

  function closeNotesEditor() {
    notesModal.style.display = "none";
    editId = null;
    editName = null;
  }

  closeNotes.addEventListener("click", closeNotesEditor);
  notesModal.addEventListener("click", (e) => {
    if (e.target === notesModal) closeNotesEditor();
  });

  saveNotes.addEventListener("click", async () => {
    if (!editId) return;

    const text = notesArea.value;
    saveStatus.textContent = "Savingâ€¦";
    saveNotes.disabled = true;

    try {
      await setDoc(countryDocRef(editId), { notes: text }, { merge: true });
      notesById[editId] = text;
      saveStatus.textContent = "Saved âœ…";
      closeNotesEditor();
    } catch (e) {
      console.error("Save failed:", e);
      saveStatus.textContent = "Save failed âŒ";
    } finally {
      saveNotes.disabled = false;
    }
  });

  deleteNotes.addEventListener("click", async () => {
    if (!editId) return;
    if (!confirm(`Delete notes for ${editName} (${editId})?`)) return;

    try {
      await setDoc(countryDocRef(editId), { notes: "" }, { merge: true });
      notesById[editId] = "";
      notesArea.value = "";
    } catch (e) {
      console.error("Delete failed:", e);
      alert("Delete failed (permissions?)");
    }
  });

  floatingNotesBtn.addEventListener("click", async () => {
    if (!hoverId) return;
    await openNotesEditor(hoverId, hoverName || hoverId);
  });

  // Counters
  const triedCountEl    = document.getElementById("triedCount");
  const totryCountEl    = document.getElementById("totryCount");
  const notTriedCountEl = document.getElementById("notTriedCount");

  const totalCountEl  = document.getElementById("totalCount");
  const totalCountEl2 = document.getElementById("totalCount2");
  const totalCountEl3 = document.getElementById("totalCount3");

  let totalCountries = 0;

  function updateCounters() {
    let tried = 0;
    let totry = 0;

    for (const id in statusById) {
      if (statusById[id] === 1) tried++;
      else if (statusById[id] === 2) totry++;
    }

    const total = totalCountries || 0;
    const notTried = Math.max(0, total - tried - totry);

    triedCountEl.textContent = String(tried);
    totryCountEl.textContent = String(totry);
    notTriedCountEl.textContent = String(notTried);

    totalCountEl.textContent  = String(total);
    totalCountEl2.textContent = String(total);
    totalCountEl3.textContent = String(total);
  }

  // Map init
  let chart, polygonSeries;

  // ------------- Flash helper (YELLOW, 5s) -------------
  function flashPolygonYellow5s(polygon) {
    if (!polygon) return;

    // stop any previous flashing
    if (polygon.__flashTimer) {
      clearInterval(polygon.__flashTimer);
      polygon.__flashTimer = null;
    }
    if (polygon.__flashTimeout) {
      clearTimeout(polygon.__flashTimeout);
      polygon.__flashTimeout = null;
    }

    const durationMs = 5000;
    const intervalMs = 200;
    const start = Date.now();
    let on = false;

    const toggle = () => {
      on = !on;
      polygon.states.applyAnimate(on ? "flash" : "default", { duration: 100 });

      if (Date.now() - start >= durationMs) {
        clearInterval(polygon.__flashTimer);
        polygon.__flashTimer = null;

        // end in default (which returns to adapter-based fill: grey/green/orange)
        polygon.__flashTimeout = setTimeout(() => {
          try { polygon.states.applyAnimate("default", { duration: 150 }); } catch {}
          polygon.__flashTimeout = null;
        }, 120);
      }
    };

    toggle(); // start immediately
    polygon.__flashTimer = setInterval(toggle, intervalMs);
  }

  // Random picker
  const randomBtn = document.getElementById("randomBtn");
  const randomPickEl = document.getElementById("randomPick");

  function pickRandomNotTried() {
    if (!polygonSeries || !chart) return;

    const candidates = [];
    polygonSeries.mapPolygons.each((polygon) => {
      const id = polygon.dataItem.get("id");
      const s = statusById[id] || 0;
      if (s === 0) candidates.push(polygon);
    });

    if (candidates.length === 0) {
      randomPickEl.textContent = "âœ… All countries have been tried / to-try!";
      return;
    }

    const chosen = candidates[Math.floor(Math.random() * candidates.length)];
    const id = chosen.dataItem.get("id");
    const name = chosen.dataItem.dataContext.name || id;

    randomPickEl.textContent = `Next: ${name} (${id})`;

    // Rotate globe towards the country (best-effort)
    try {
      const geo = chosen.dataItem.get("geometry");
      if (geo) {
        const center = am5map.getGeoCentroid(geo);
        if (center) {
          chart.animate({
            key: "rotationX",
            to: -center.longitude,
            duration: 800,
            easing: am5.ease.out(am5.ease.cubic)
          });
          chart.animate({
            key: "rotationY",
            to: -center.latitude,
            duration: 800,
            easing: am5.ease.out(am5.ease.cubic)
          });
        }
      }
    } catch (e) {
      console.warn("Rotation skipped:", e);
    }

    // Flash YELLOW for 5 seconds
    flashPolygonYellow5s(chosen);
  }

  randomBtn.addEventListener("click", pickRandomNotTried);

  function initMap() {
    const root = am5.Root.new("chartdiv");
    root.setThemes([am5themes_Animated.new(root)]);

    chart = root.container.children.push(
      am5map.MapChart.new(root, {
        projection: am5map.geoOrthographic(),
        panX: "rotateX",
        panY: "rotateY"
      })
    );

    polygonSeries = chart.series.push(
      am5map.MapPolygonSeries.new(root, {
        geoJSON: am5geodata_worldLow
      })
    );

    polygonSeries.mapPolygons.template.setAll({
      tooltipText: "{name}",
      interactive: true,
      strokeOpacity: 1,
      stroke: am5.color(0x666666),
      strokeWidth: 0.6,
      fillOpacity: 0.85
    });

    polygonSeries.mapPolygons.template.set("fill", am5.color(COLOR_DEFAULT));

    // Permanent fill based on status
    polygonSeries.mapPolygons.template.adapters.add("fill", (fill, target) => {
      const id = target.dataItem?.get("id");
      const s = statusById[id] || 0;

      if (s === 1) return am5.color(COLOR_TRIED);
      if (s === 2) return am5.color(COLOR_TOTRY);
      return am5.color(COLOR_DEFAULT);
    });

    // Hover effect
    polygonSeries.mapPolygons.template.states.create("hover", {
      strokeWidth: 2
    });

    // Flash state (YELLOW)
    polygonSeries.mapPolygons.template.states.create("flash", {
      fill: am5.color(COLOR_FLASH),
      strokeWidth: 2.5
    });

    polygonSeries.events.on("datavalidated", () => {
      totalCountries = polygonSeries.mapPolygons.length;
      updateCounters();
    });

    polygonSeries.mapPolygons.template.events.on("click", async (ev) => {
      const polygon = ev.target;
      const id = polygon.dataItem.get("id");
      const name = polygon.dataItem.dataContext.name || id;

      const oe = ev.originalEvent;
      if (oe && oe.shiftKey) {
        await openNotesEditor(id, name);
        return;
      }

      const current = statusById[id] || 0;
      const next = (current + 1) % 3;
      statusById[id] = next;

      polygon.markDirtyKey("fill");
      updateCounters();

      try {
        await setDoc(countryDocRef(id), { status: next }, { merge: true });
      } catch (e) {
        console.error("Status save failed:", e);
        alert("Could not save status (permissions?)");
      }
    });

    polygonSeries.mapPolygons.template.events.on("pointerover", (ev) => {
      const polygon = ev.target;
      const id = polygon.dataItem.get("id");
      const name = polygon.dataItem.dataContext.name || id;

      hoverId = id;
      hoverName = name;

      const hasNotes = !!(notesById[id] && notesById[id].trim());
      floatingNotesBtn.textContent = hasNotes ? "Edit notes âœŽ" : "Add notes +";
      floatingNotes.style.display = "block";
    });

    polygonSeries.mapPolygons.template.events.on("pointermove", (ev) => {
      const oe = ev.originalEvent;
      if (oe && typeof oe.clientX === "number") {
        floatingNotes.style.left = oe.clientX + "px";
        floatingNotes.style.top  = oe.clientY + "px";
      }
    });

    polygonSeries.mapPolygons.template.events.on("pointerout", () => {
      hoverId = null;
      hoverName = null;
      floatingNotes.style.display = "none";
    });

    chart.appear(1000, 100);
  }

  function startLiveSync() {
    const countriesCol = collection(db, "maps", MAP_ID, "countries");

    onSnapshot(countriesCol, (snap) => {
      for (const k in statusById) delete statusById[k];
      for (const k in notesById) delete notesById[k];

      snap.forEach((docSnap) => {
        const id = docSnap.id;
        const data = docSnap.data();
        statusById[id] = Number(data.status || 0);
        notesById[id] = (data.notes || "");
      });

      if (polygonSeries) {
        polygonSeries.mapPolygons.each((polygon) => polygon.markDirtyKey("fill"));
      }

      updateCounters();
    });
  }

  let started = false;

  onAuthStateChanged(auth, (user) => {
    if (!user) {
      whoami.textContent = "Friends only";
      signinBtn.style.display = "inline-block";
      signoutBtn.style.display = "none";
      return;
    }

    whoami.textContent = user.email || "Signed in";
    signinBtn.style.display = "none";
    signoutBtn.style.display = "inline-block";

    if (!started) {
      started = true;
      initMap();
      startLiveSync();
    }
  });
</script>

</body>
</html>
